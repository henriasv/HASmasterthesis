\chapter{Molecular dynamics}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Introduction}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
Molecular dynamics is ...
We are not interested in trajectories, we are interested in statistically correct behavior. 

\section{Potentials}

\subsection{Lennard-Jones}
Perhaps the simplest potential widely used in molecular dynamics is the Lennard-Jones potential. For two particles separated with a distance $r$, it looks like:
\begin{equation}
	U_{LJ} = 4\varepsilon\left[\left(\frac{\sigma}{r}\right)^{12} - \left(\frac{\sigma}{r}\right)^{6}\right]
\end{equation}

\subsection{Coulombic potentials}
Coulombic potentials are used for charges particles, and is equivalent to Coulombs law:
\begin{equation}
	U_e = k\frac{q_iq_j}{r_{ij}}
\end{equation}


\subsection{Bonded and angular potentials}

\subsection{Reactive potentials}
Reactive potentials are potentials that allow for chemical reactions.

\section{Integration, thermostats, barostats}

\section{Thermostats}
Thermostats are applied to control temperature of a system. Some thermostats can be shown to make the system sample some thermodynamic ensemble. Thermostatting can be closely intertwined with integration in the sense that thermostatting represents a change in the integration scheme. 
\subsection{Berendsen thermostat}
\subsection{Nosé-Hoover thermostat}


\section{Long range corrections}
For slowly decaying potentials, such as Coulombic potentials, it is not advisible to use a cutoff distance, as this might result in severe inaccuracies. However, there are techniques that allows compensation withoud doing a full pairwise computation. 
\subsection{Ewald summation}
\subsection{Particle-particle-particle-mesh (PPPM)}

\section{Thermodynamic measurements}
\subsection{Temperature}
\subsection{Virial pressure and virial stress}
The pressure in a general classical N-body system can be expressed based on the virial equation for the pressure.

A precise formulation of the stress tensor is given in \cite{Thompson2009}.
The virial of a system consiting of N interacting particles is defined as:
\begin{equation}
	W(\rvec^N) \equiv -3V\frac{\dd U(\rvec^N)}{\dd V}
\end{equation}
Where $U$ is the potential energy of the system, which in molecular dynamics is only a function of the postitions of the particles and their interaction potentials.


\paragraph{Long-range contributions to the virial}
Since we needed to introduce the PPPM calculation to deal with long-range forces, we also need to know how this correction affects the virial tensor, in order to include it in the stress measurement. \cite{Sirk2013} shows how to make long-rage corrections to the virial when computing long-range forces with PPPM.


\subsection{Thermal Diffusivity}
Thermal diffusivity can be measured with the Einstein relation:
\begin{equation}
	D_E = \lim_{t\to\infty} \frac{1}{6} \frac{\dd \langle \left|\rvec(t) - \rvec(0)\right|^2\rangle}{\dd t}
	\label{eq:Einstein_diffusivity}
\end{equation}
Where `E' means that $D$ was estimated using the Einstein relation. It was shown in \cite{Yeh2004} that the diffusion coefficients in periodic simulation boxes depend on the system size, and goes like $L^{-1}$. Thus, a reference diffusivity $D_0$, corresponding to an infinite system and which can be compared with experimental results, can be found by extrapolation.


\section{Other properties}
\subsection{Viscosity}
For calculating the viscosity, I use the Green-Kubo relation:
\begin{equation}
	\eta_{GK} = \frac{V}{k_B T} \int_0^\infty \langle \sigma_{\alpha\beta}(t) \sigma_{\alpha\beta}(0) \rangle\ \dd t
	\label{eq:GK_shear_viscosity}
\end{equation}
% http://www.nyu.edu/classes/tuckerman/stat.mech/lectures/lecture_21/node6.html
Where $\sigma_{\alpha\beta}$ are independent off-diagonal elements of the stress tensor of the system. These can be $\sigma_{xy}$, $\sigma_{xz}$, $\sigma_{yz}$, $(\sigma_{xx}-\sigma_{yy})/2$ and $(\sigma_{yy}-\sigma_{zz})/2$. The expectation value inside the integral assumes that a large number of systems are investigated. Through the ergodic hypothesis, we can transform the autocorrelation function to a time integral. Also, since infinite time series are not available in practice, I introduce finite bounds on the integrals. 
\begin{equation}
	\eta_{GK}(t, T) = \frac{V}{k_B T} \int_0^t  \frac{1}{\tau} \int_0^\tau \sigma_{\alpha\beta}(\tau'+t') \sigma_{\alpha\beta}(\tau')\ \dd \tau'\ \dd t' 
\label{eq:GK_shear_viscosity_estimate}
\end{equation}
For the purpose of estimating viscosities, the autocorrelation function is only well sampled for $t <<< \tau$. Luckily, the autocorrelation function is essentially zero for times larger that some system-specific characteristic time, which is usually in the order of picoseconds, at least for water. That means $\eta_{GK}(t, T)$ can provide good estimates of the viscosity for molecular dynamics simulations that last for nanoseconds.


Following \cite{Yeh2004}, it would also be possible to calculate the viscosity using the finite size effect on the thermal diffusivity.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Rigid molecules - The SETTLE algorithm}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
There are several ways to keep a group of atoms constrained as a rigid molecule. The goal is to obtain the same result as if the equation was integrated using holonomic constraints, but integrating the angular movement of rigid particles instead of ...***. Generally, one can use the SHAKE or the RATTLE algorithm. For the particular case of three rigid atoms, the SETTLE algorithm might be preferred. The SETTLE algorithm \cite{Miyamoto1992} is an analytical solution to the 3-particle constraint problem when integrating numerically the newtonian equations of motion. It implements the contraint by changing the positions and velocities of the constrained particles after each integration step.

The basic idea of the SETTLE algorithm is to use the positions on a triangle before, $\Delta A_0 B_0 C_0$, and after, $\Delta A_1 B_1 C_1$, an unconstrained integration step to determine rotation operations to perform on $\Delta A_0 B_0 C_0$ to achieve a triangle $\Delta A_3 B_3 C_3$ corresponding to a constrained integration step. When we know the rotation operations, we also know the positions $(A_3, B_3, C_3)$ which are what we want for an implementation of the algorithm.

Let us look at the water molecule as a triangle placed in the $X'Y'$ plane of an orthogonal coordinate system $X'Y'Z'$	with the center of mass in the origin, and the oxygen atom placed on the positive y-axis. We denote the triangle $\Delta abc$ beginning with $a$ being the position of oxygen, and $b$ and $c$ the hydrogen positions in the positive direction of rotation around the origin.  In this coordinate system, the triangle is uniquely defined by three numbers: $(r_a, r_b, r_c)$ being the position components $a_y$, $-b_y$ and $c_x$. Triangles denoted by lowercase letters are the canonical water molecule, or the equilibrium configuration. $\Delta ABC$ is a triangle with possibly any positions of the corners, on which we want to perform the contrain operation to get back to the canonical triangle. 

The main derivation of the settle algorithm involve four planes, $\pi_0, \pi_A, \pi_B, \pi_C$ and the assumption that displacement vector for each apex from the unconstrained to the constrained triangle should be parallell to the plane $\pi_0$ of the triangle before the integration step. 

The actual steps to perform in the SETTLE algorithm are (in primed coordinates):
\paragraph{Positions}
\begin{enumerate}
\item Calculate $\phi$ and $\psi$: \\
$\phi$ and $\psi$ can be calculated without any knowledge of forces.
\begin{equation}
\sin\phi = \frac{Z_{A_1}'}{r_a}
\end{equation}
\begin{equation}
\sin\psi = \frac{Z_{B_1}' - Z_{C_1}'}{2r_c\cos\phi}
\end{equation}

\item Obtain intermidiate coordinates
\begin{align}
(X_{a_2}', Y_{a_2}',Z_{a_2}') &= (0, r_c\cos\phi, r_c\sin\phi)\\
(X_{b_2}', Y_{b_2}',Z_{b_2}') &= (-r_c\cos\psi, -r_b\cos\phi - r_c\sin\psi\sin\phi, -r_b\sin\phi + r_c\sin\psi\cos\phi)\\
(X_{c_2}', Y_{c_2}',Z_{c_2}') &= (r_c\cos\psi, -r_b\cos\phi + r_c\sin\psi\sin\phi, -r_b\sin\phi - r_c\sin\psi\cos\phi)
\end{align}

\item Calculate $\theta$ from assumption on forces, positions and velocities: \\
\begin{align}
	\alpha &= X'_{b_2} ( X'_{B_0}  -X'_{C_0})  +
	Y'_{b_2}( Y'_{B_0}  -Y'_{A_0}) 	+
		Y'_{c_2}( Y'_{C_0}  -Y'_{A_0}) \\
	\beta &= X'_{b_2} ( Y'_{C_0}  -Y'_{B_0})
		 		+Y'_{b_2}( X'_{B_0}  -X'_{A_0}) 	+
		 		Y'_{c_2}( X'_{C_0}  -X'_{A_0}) \\
	\gamma &= Y'_{B_1} ( X'_{B_0}  -X'_{A_0})
			-X'_{B_1}( Y'_{B_0}  -Y'_{A_0}) 	+
			Y'_{C_1}( X'_{C_0}  -X'_{A_0}) 	-
			X'_{C_1}( Y'_{C_0} - Y'_{A_0})
\end{align}
\begin{equation}
\sin \theta = \frac{\alpha\gamma - \beta \sqrt{\alpha^2 + \beta^2 - \gamma^2 )}}{\alpha^2 + \beta^2}
\end{equation}

\item Obtain final coordinates
\begin{align}
(X_{a_3}', Y_{a_3}',Z_{a_3}') &= 	(X_{a_2}' \cos\theta - Y_{a_2}'\sin\theta,
									 X_{a_2}' \sin\theta + Y_{a_2}'\cos\theta, Z_{a_2}')\\
(X_{b_3}', Y_{b_3}',Z_{b_3}') &= 	(X_{b_2}' \cos\theta - Y_{b_2}'\sin\theta, 
									 X_{b_2}' \sin\theta + Y_{b_2}'\cos\theta, Z_{b_2}')\\
(X_{c_3}', Y_{c_3}',Z_{c_3}') &=	(X_{c_2}' \cos\theta - Y_{c_2}'\sin\theta, 
									 X_{c_2}' \sin\theta + Y_{c_2}'\cos\theta, Z_{c_2}')
\end{align}
\end{enumerate}

\paragraph{Velocities}
The following is only valid within the velocity verlet algorithm.
